{% extends "base.html" %}

{% block title %}SkillSwap - Messages{% endblock %}

{% block extra_css %}
<style>
    .message-container {
        height: 450px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fb;
        border-radius: 8px;
    }
    .conversation-list-container {
        height: 550px;
        overflow-y: auto;
    }
    .conversation-item {
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid transparent;
    }
    .conversation-item:hover {
        background-color: #f8f9fa;
    }
    .conversation-item.active {
        background-color: #eef2ff;
        border-left-color: #667eea;
    }
    .chat-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4 gradient-text fw-bold">Messages ðŸ’¬</h2>

    <div class="row">
        <div class="col-md-4">
            <div class="card modern-card shadow-sm">
                <div class="card-body p-0">
                    <div class="p-3 border-bottom bg-light">
                        <h5 class="mb-0">Inbox</h5>
                    </div>
                    <div id="conversations" class="conversation-list-container">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2 text-muted">Loading chats...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card modern-card shadow-sm h-100">
                <div class="card-body">
                    <div id="chat-area">
                        <div class="text-center py-5">
                            <i class="bi bi-chat-left-dots display-1 text-light"></i>
                            <h4 class="mt-3 text-secondary">Your Conversations</h4>
                            <p class="text-muted">Select a person from the left to start skill swapping.</p>
                        </div>
                    </div>
                    
                    <div id="message-form" style="display: none;" class="mt-3">
                        <div class="input-group shadow-sm rounded">
                            <textarea id="message-input" class="form-control form-control-modern" 
                                      placeholder="Type your message..." rows="1"></textarea>
                            <button onclick="sendMessage()" class="btn btn-modern">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedUser = null;
    
    // Load conversations and group them
    async function loadConversations() {
        const currentEmail = window.userEmail;
        
        try {
            const response = await fetch(`/messages/${currentEmail}`);
            const messages = await response.json();
            const conversations = {};
            
            messages.forEach(msg => {
                const otherEmail = msg.sender_email === currentEmail ? msg.receiver_email : msg.sender_email;
                const otherName = msg.sender_email === currentEmail ? msg.receiver_name : msg.sender_name;
                
                if (!conversations[otherEmail]) {
                    conversations[otherEmail] = {
                        email: otherEmail,
                        name: otherName || otherEmail.split('@')[0],
                        lastMessage: msg.content,
                        timestamp: new Date(msg.timestamp)
                    };
                }
            });
            
            const container = document.getElementById('conversations');
            if (Object.keys(conversations).length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-muted">No messages yet.</div>';
                return conversations;
            }

            let html = '';
            Object.values(conversations).sort((a,b) => b.timestamp - a.timestamp).forEach(conv => {
                const isActive = selectedUser && selectedUser.email === conv.email ? 'active' : '';
                html += `
                    <div class="conversation-item p-3 border-bottom ${isActive}" id="conv-${btoa(conv.email).replace(/=/g, '')}"
                         onclick="selectConversation('${conv.email}', '${conv.name}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="d-block text-dark">${conv.name}</strong>
                                <small class="text-muted text-truncate d-inline-block" style="max-width: 150px;">
                                    ${conv.lastMessage}
                                </small>
                            </div>
                            <button onclick="event.stopPropagation(); startVideoCall('${conv.email}', '${conv.name}')" 
                                    class="btn btn-outline-success btn-sm rounded-circle">
                                <i class="bi bi-camera-video"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            return conversations;
        } catch (err) {
            console.error("Error:", err);
            document.getElementById('conversations').innerHTML = '<p class="p-3 text-danger">Failed to load.</p>';
        }
    }
    
    // Select conversation and show messages
    function selectConversation(otherEmail, otherName) {
        selectedUser = { email: otherEmail, name: otherName };
        const currentEmail = window.userEmail;

        // UI Updates: Highlight selected and show input
        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`conv-${btoa(otherEmail).replace(/=/g, '')}`);
        if(activeItem) activeItem.classList.add('active');
        
        document.getElementById('message-form').style.display = 'block';

        fetch(`/messages/conversation/${currentEmail}/${otherEmail}`)
            .then(response => response.json())
            .then(messages => {
                let html = `
                    <div class="chat-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-0 text-primary">${otherName}</h5>
                            <small class="text-muted">${otherEmail}</small>
                        </div>
                        <button onclick="startVideoCall('${otherEmail}', '${otherName}')" class="btn btn-success btn-sm rounded-pill px-3">
                            <i class="bi bi-camera-video-fill me-1"></i> Video Call
                        </button>
                    </div>
                    <div class="message-container" id="msg-inner-container">`;
                
                if (messages.length === 0) {
                    html += '<p class="text-center text-muted py-5">No messages yet. Start the conversation!</p>';
                } else {
                    messages.forEach(msg => {
                        const isSent = msg.sender_email === currentEmail;
                        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        html += `
                            <div class="d-flex ${isSent ? 'justify-content-end' : 'justify-content-start'} mb-3">
                                <div class="${isSent ? 'message-sent' : 'message-received shadow-sm'}">
                                    <div class="small fw-bold mb-1" style="font-size: 0.7rem;">${isSent ? 'You' : otherName}</div>
                                    <div>${msg.content}</div>
                                    <div class="text-end" style="font-size: 0.6rem; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('chat-area').innerHTML = html;
                
                const innerContainer = document.getElementById('msg-inner-container');
                innerContainer.scrollTop = innerContainer.scrollHeight;
            });
    }
    
    // Send message function
    function sendMessage() {
        if (!selectedUser) return;
        const currentEmail = window.userEmail;
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;
        
        fetch(`/messages/send?sender_email=${currentEmail}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ receiver_email: selectedUser.email, content: content })
        })
        .then(() => {
            input.value = '';
            selectConversation(selectedUser.email, selectedUser.name);
            loadConversations();
        });
    }

    // Handle Enter Key
    document.getElementById('message-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Initial Load & Auto-select Logic
    document.addEventListener('DOMContentLoaded', () => {
        loadConversations().then(conversations => {
            const urlParams = new URLSearchParams(window.location.search);
            const startWith = urlParams.get('start_with');
            
            if (startWith) {
                // Determine name: either from existing conversations or partial email
                let displayName = startWith.split('@')[0];
                if (conversations && conversations[startWith]) {
                    displayName = conversations[startWith].name;
                }
                selectConversation(startWith, displayName);
            }
        });
    });
</script>
{% endblock %}